version: "3.9"

services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ../init-scripts:/docker-entrypoint-initdb.d        # ðŸ‘ˆ init scripts mounted here
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks: [ microservices ]

  # ----------------- RabbitMQ -----------------
  rabbitmq:
    image: rabbitmq:4-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "check_running" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks: [ microservices ]

  # ----------------- Eureka -----------------
  eurekaserver:
    image: "harintharan/saloon-eureka-server:v2"
    container_name: eurekaserver
    ports:
      - "8088:8088"
    healthcheck:
      test: [ "CMD-SHELL", "curl --fail --silent http://eurekaserver:8088/actuator/health | grep UP || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 700m
    networks: [ microservices ]

  # ----------------- Keycloak -----------------
  #  keycloak:
  #    image: quay.io/keycloak/keycloak:26.0.0
  #    container_name: keycloak
  #    command: start-dev
  #    environment:
  #      KEYCLOAK_ADMIN: admin
  #      KEYCLOAK_ADMIN_PASSWORD: admin
  #    ports:
  #      - "3333:8080"
  #    volumes:
  #      - keycloak_data:/opt/keycloak/data
  #    healthcheck:
  #      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health/ready || exit 1"]
  #      interval: 15s
  #      timeout: 5s
  #      retries: 20
  #      start_period: 60s
  #    networks: [microservices]

  keycloak:
    image: quay.io/keycloak/keycloak:26.0.0
    container_name: keycloak
    command: start-dev --health-enabled=true --metrics-enabled=true --http-enabled=true --hostname-strict=false
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      KC_HTTP_ENABLED: true
      KC_HOSTNAME_STRICT: false
      KC_MANAGEMENT_HOST: 0.0.0.0
      KC_MANAGEMENT_PORT: 9000
    ports:
      - "3333:8080"    # main http
      - "9000:9000"    # mgmt/health
    volumes:
      - keycloak_data:/opt/keycloak/data
    healthcheck:
      test: [ "CMD-SHELL", "curl -fsS http://localhost:9000/health/ready || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 60s
    networks:
      - microservices




#  # ----------------- Microservices -----------------
#  booking:
#    image: "harintharan/saloon-booking-service:v2"
#    container_name: booking
#    ports:
#      - "8086:8086"
#    depends_on:
#      mysql:
#        condition: service_healthy
#      rabbitmq:
#        condition: service_healthy
#      eurekaserver:
#        condition: service_healthy
#    environment:
#      SPRING_APPLICATION_NAME: booking-service
#      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/bookingdb
#      SPRING_DATASOURCE_USERNAME: root
#      SPRING_DATASOURCE_PASSWORD: root
#      SPRING_RABBITMQ_HOST: rabbitmq
#      SPRING_RABBITMQ_PORT: 5672
#      SPRING_RABBITMQ_USERNAME: guest
#      SPRING_RABBITMQ_PASSWORD: guest
#      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8088/eureka/
#    deploy:
#      resources:
#        limits:
#          memory: 700m
#    networks: [ microservices ]
#
#  payment:
#    image: "harintharan/saloon-payment-service:v2"
#    container_name: payment
#    ports:
#      - "8087:8087"
#    depends_on:
#      mysql:
#        condition: service_healthy
#      rabbitmq:
#        condition: service_healthy
#      eurekaserver:
#        condition: service_healthy
#    environment:
#      SPRING_APPLICATION_NAME: payment-microservice
#      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/paymentdb
#      SPRING_DATASOURCE_USERNAME: root
#      SPRING_DATASOURCE_PASSWORD: root
#      SPRING_RABBITMQ_HOST: rabbitmq
#      SPRING_RABBITMQ_PORT: 5672
#      SPRING_RABBITMQ_USERNAME: guest
#      SPRING_RABBITMQ_PASSWORD: guest
#      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8088/eureka/
#    deploy:
#      resources:
#        limits:
#          memory: 700m
#    networks: [ microservices ]
#
#
#  notification:
#    image: "harintharan/saloon-notifications-service:v2"
#    container_name: notification
#    ports:
#      - "9001:9001"
#    depends_on:
#      mysql:
#        condition: service_healthy
#      rabbitmq:
#        condition: service_healthy
#      eurekaserver:
#        condition: service_healthy
#    environment:
#      SPRING_APPLICATION_NAME: notifications-service
#      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/notificationdb
#      SPRING_DATASOURCE_USERNAME: root
#      SPRING_DATASOURCE_PASSWORD: root
#      SPRING_RABBITMQ_HOST: rabbitmq
#      SPRING_RABBITMQ_PORT: 5672
#      SPRING_RABBITMQ_USERNAME: guest
#      SPRING_RABBITMQ_PASSWORD: guest
#      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8088/eureka/
#    deploy:
#      resources:
#        limits:
#          memory: 700m
#    networks: [ microservices ]
#
#
#  category:
#    image: "harintharan/saloon-catagary-service:v2"
#    container_name: category
#    ports:
#      - "8084:8084"
#    depends_on:
#      mysql:
#        condition: service_healthy
#      eurekaserver:
#        condition: service_healthy
#    environment:
#      SPRING_APPLICATION_NAME: category-service
#      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/categorydb
#      SPRING_DATASOURCE_USERNAME: root
#      SPRING_DATASOURCE_PASSWORD: root
#      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8088/eureka/
#    deploy:
#      resources:
#        limits:
#          memory: 700m
#    networks: [ microservices ]
#
#
#
#
#  review:
#    image: "harintharan/saloon-review-service:v2"
#    container_name: review
#    ports:
#      - "9002:9002"
#    depends_on:
#      mysql:
#        condition: service_healthy
#      eurekaserver:
#        condition: service_healthy
#    environment:
#      SPRING_APPLICATION_NAME: review-microservice
#      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/reviewdb
#      SPRING_DATASOURCE_USERNAME: root
#      SPRING_DATASOURCE_PASSWORD: root
#      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8088/eureka/
#    deploy:
#      resources:
#        limits:
#          memory: 700m
#    networks: [ microservices ]
#
#
#  saloon-service:
#    image: "harintharan/saloon-service:v2"
#    container_name: saloon-service
#    ports:
#      - "8083:8083"
#    depends_on:
#      mysql:
#        condition: service_healthy
#      eurekaserver:
#        condition: service_healthy
#    environment:
#      SPRING_APPLICATION_NAME: saloon-service
#      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/saloonDb
#      SPRING_DATASOURCE_USERNAME: root
#      SPRING_DATASOURCE_PASSWORD: root
#      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8088/eureka/
#    deploy:
#      resources:
#        limits:
#          memory: 700m
#    networks: [ microservices ]
#
#
#  service-offering:
#    image: "harintharan/saloon-service-offering:v2"
#    container_name: service-offering
#    ports:
#      - "8085:8085"
#    depends_on:
#      mysql:
#        condition: service_healthy
#      eurekaserver:
#        condition: service_healthy
#    environment:
#      SPRING_APPLICATION_NAME: service-offering
#      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/saloonServiceDB
#      SPRING_DATASOURCE_USERNAME: root
#      SPRING_DATASOURCE_PASSWORD: root
#      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8088/eureka/
#    deploy:
#      resources:
#        limits:
#          memory: 700m
#    networks: [ microservices ]




#  user:
#    image: "harintharan/saloon-user:v2"
#    container_name: user
#    ports:
#      - "8082:8082"
#    depends_on:
#      mysql:
#        condition: service_healthy
#      eurekaserver:
#        condition: service_healthy
#    environment:
#      SPRING_APPLICATION_NAME: user-service
#      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/userdb
#      SPRING_DATASOURCE_USERNAME: root
#      SPRING_DATASOURCE_PASSWORD: root
#      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8088/eureka/
#    deploy:
#      resources:
#        limits:
#          memory: 700m
#    networks: [ microservices ]



  # ----------------- API Gateway -----------------
  gateway:
    image: "harintharan/saloon-gateway-server:v2"
    container_name: gateway
    ports:
      - "8089:8089"
    depends_on:
      eurekaserver:
        condition: service_healthy
      keycloak:
        condition: service_started   # ðŸ‘ˆ only wait for container to start, not health
    environment:
      SPRING_APPLICATION_NAME: gateway-service
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8088/eureka/
      KEYCLOAK_AUTH_SERVER_URL: http://keycloak:8080
      KEYCLOAK_REALM: master
      KEYCLOAK_RESOURCE: gateway-client
    deploy:
      resources:
        limits:
          memory: 700m
    networks:
      - microservices


# ----------------- Volumes -----------------
volumes:
  mysql_data:
  rabbitmq_data:
  keycloak_data:


# ----------------- Network -----------------
networks:
  microservices:
    driver: bridge
